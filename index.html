<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Ramallah Waste Containers</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
<style>
  body { margin:0; height:100%; width:100%; }
  #map { position:absolute; width:100%; top:0; bottom:0; }
  .coords { background: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; font-size: 12px; }
  .popup-camera { display:flex; flex-direction:column; }
  .popup-camera button { margin-top:5px; }
  #cameraModal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000; }
  #cameraModal video, #cameraModal canvas { max-width:90%; max-height:80%; border:2px solid white; border-radius:5px; }
  #cameraModal button { margin-top:10px; }
</style>
</head>
<body>
<div id="map"></div>

<div id="cameraModal">
  <div style="display:flex; flex-direction:column; align-items:center;">
    <video id="video" autoplay></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <button id="snapBtn">التقاط الصورة</button>
    <button id="closeBtn">إغلاق</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
<script>
const map = L.map('map', { zoomSnap:0.5, center:[31.9045,35.2045], zoom:17.5 });

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; <a href="https://www.openstreetmap.org/">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains:'abcd', maxZoom:20
}).addTo(map);

L.control.scale({position:'bottomleft', metric:true, imperial:false, maxWidth:200}).addTo(map);

// عرض الإحداثيات
const coordsDiv = L.control({position:'topright'});
coordsDiv.onAdd = function(map){ this._div = L.DomUtil.create('div','coords'); this.update(); return this._div; };
coordsDiv.update = function(latlng){ this._div.innerHTML = latlng ? `Lat: ${latlng.lat.toFixed(6)}<br>Lng: ${latlng.lng.toFixed(6)}` : 'مرر الماوس على الخريطة'; };
coordsDiv.addTo(map);
map.on('mousemove', e => coordsDiv.update(e.latlng));

// بيانات تجريبية للـ Zones (Polygon)
const zonesData = {
  "type":"FeatureCollection",
  "features":[
    {
      "type":"Feature",
      "properties":{"TYPE_OF_WA":"Al-Bireh"},
      "geometry":{"type":"Polygon","coordinates":[[[35.203,31.903],[35.206,31.903],[35.206,31.906],[35.203,31.906],[35.203,31.903]]]}
    },
    {
      "type":"Feature",
      "properties":{"TYPE_OF_WA":"Ramallah City"},
      "geometry":{"type":"Polygon","coordinates":[[[35.204,31.902],[35.207,31.902],[35.207,31.905],[35.204,31.905],[35.204,31.902]]]}
    }
  ]
};

// بيانات تجريبية للـ Waste Containers (Points)
const wasteContainersData = {
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","properties":{"ID":"C1"},"geometry":{"type":"Point","coordinates":[35.2045,31.9045]}},
    {"type":"Feature","properties":{"ID":"C2"},"geometry":{"type":"Point","coordinates":[35.2050,31.9050]}},
    {"type":"Feature","properties":{"ID":"C3"},"geometry":{"type":"Point","coordinates":[35.2055,31.9040]}}
  ]
};

// إنشاء طبقة المناطق
const zonesLayer = L.geoJson(zonesData,{
  style: f => ({fillColor:'yellow', fillOpacity:0.3, color:'yellow', weight:1, opacity:0.7}),
  onEachFeature: function(feature, layer){
    const zoneName = feature.properties.TYPE_OF_WA || "غير معروف";
    layer.bindPopup("اسم المنطقة: " + zoneName);
  }
}).addTo(map);

// الكاميرا
const cameraModal = document.getElementById('cameraModal');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const snapBtn = document.getElementById('snapBtn');
const closeBtn = document.getElementById('closeBtn');
let currentContainerId = null;

function openCamera(containerId){
  currentContainerId = containerId;
  cameraModal.style.display = 'flex';
  navigator.mediaDevices.getUserMedia({video:true})
    .then(stream => { video.srcObject = stream; })
    .catch(err => { alert("لا يمكن الوصول إلى الكاميرا: "+err); });
}

snapBtn.addEventListener('click', ()=>{
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const context = canvas.getContext('2d');
  context.drawImage(video,0,0,canvas.width,canvas.height);
  const imageData = canvas.toDataURL('image/png');

  const imageDiv = document.getElementById(`containerImage_${currentContainerId}`);
  if(imageDiv) imageDiv.innerHTML = `<img src="${imageData}" style="max-width:100%; margin-top:5px; border:1px solid #ccc;">`;

  const a = document.createElement('a');
  a.href = imageData;
  a.download = `Container_${currentContainerId}.png`;
  a.click();

  alert("تم التقاط الصورة وحفظها للحاوية ID: " + currentContainerId);
});

closeBtn.addEventListener('click', ()=>{
  cameraModal.style.display = 'none';
  if(video.srcObject){
    video.srcObject.getTracks().forEach(track => track.stop());
    video.srcObject = null;
  }
});

// إنشاء طبقة الحاويات
const wasteContainersLayer = L.geoJson(wasteContainersData,{
  pointToLayer: function(feature, latlng){
    return L.circleMarker(latlng, {radius:5, fillColor:'orange', color:'orange', weight:1, opacity:1, fillOpacity:0.8});
  },
  onEachFeature: function(feature, layer){
    layer.on('click', function(){
      const popupContent = `
        <div class="popup-camera">
          <b>Container ID: ${feature.properties.ID || 'N/A'}</b>
          <button onclick="openCamera('${feature.properties.ID || 'unknown}')">تصوير الحاوية</button>
          <div id="containerImage_${feature.properties.ID}" style="margin-top:5px;"></div>
        </div>`;
      layer.bindPopup(popupContent).openPopup();
    });
  }
}).addTo(map);

// تحكم الطبقات
L.control.layers({}, {"Zones":zonesLayer,"Waste Containers":wasteContainersLayer}).addTo(map);
</script>
</body>
</html>
